{% extends "base.html" %}

{% block content %}
<h2>Zadat údaje pro doručení</h2>

<form method="post">
    {% csrf_token %}

    <h3>Doručovací adresa</h3>

    {% if user.is_authenticated %}
        {{ shipping_address_form.as_p }}
    {% else %}
        <div>
            <label for="shipping_first_name">Jméno:</label>
            <input type="text" name="shipping-first_name" id="shipping_first_name" value="{{ shipping_address_form.first_name.value|default:'' }}" required>
        </div>

        <div>
            <label for="shipping_last_name">Příjmení:</label>
            <input type="text" name="shipping-last_name" id="shipping_last_name" value="{{ shipping_address_form.last_name.value|default:'' }}" required>
        </div>

        <div>
            <label for="shipping_street">Ulice:</label>
            <input type="text" name="shipping-street" id="shipping_street" value="{{ shipping_address_form.street.value|default:'' }}" required>
        </div>

        <div>
            <label for="shipping_street_number">Číslo domu:</label>
            <input type="text" name="shipping-street_number" id="shipping_street_number" value="{{ shipping_address_form.street_number.value|default:'' }}" required>
        </div>

        <div>
            <label for="shipping_city">Město:</label>
            <input type="text" name="shipping-city" id="shipping_city" value="{{ shipping_address_form.city.value|default:'' }}" required>
        </div>

        <div>
            <label for="shipping_postal_code">PSČ:</label>
            <input type="text" name="shipping-postal_code" id="shipping_postal_code" value="{{ shipping_address_form.postal_code.value|default:'' }}" required>
        </div>

        <div>
            <label for="shipping_country">Země:</label>
            <input type="text" name="shipping-country" id="shipping_country" value="{{ shipping_address_form.country.value|default:'' }}" required>
        </div>

        <!-- Skryté pole pro e-mail -->
        <input type="hidden" name="shipping-email" id="shipping_email" value="{{ guest_email|default:'' }}">

        <!-- Pole pro zadání emailu hostujícího uživatele -->
        <div>
            <label for="guest_email">E-mail:</label>
            <input type="email" name="guest_email" id="guest_email" value="{{ guest_email }}" required>
        </div>
    {% endif %}

    <label>
        <input type="checkbox" id="differentBilling" name="different_billing">
        Fakturační adresa je jiná než doručovací
    </label>

    <div id="billingForm" style="display: none;">
        <h3>Fakturační adresa</h3>
        {{ billing_address_form.as_p }}
    </div>

    <hr>

    <button type="submit" class="btn btn-primary">Pokračovat</button>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function () {
    const guestEmailField = document.getElementById('guest_email');
    const shippingEmailField = document.querySelector('[name="shipping-email"]'); // Skryté pole email
    const differentBillingCheckbox = document.getElementById('differentBilling');
    const billingForm = document.getElementById('billingForm');
    const shippingFields = document.querySelectorAll('[name^="shipping-"]');
    const billingFields = document.querySelectorAll('[name^="billing-"]');

    // Kopíruje hodnotu emailu do skrytého pole
    function copyEmailToHiddenFields() {
        if (guestEmailField && guestEmailField.value) {
            if (shippingEmailField) {
                shippingEmailField.value = guestEmailField.value;
                console.log("Email copied to hidden field:", shippingEmailField.value);
            }
        } else {
            console.warn("Guest email field is empty or not found.");
        }
    }

    function copyShippingToBilling() {
        // Kopíruje všechny hodnoty z doručovací adresy do fakturační, včetně emailu
        shippingFields.forEach((field, index) => {
            if (billingFields[index]) {
                billingFields[index].value = field.value;
            }
        });
    }

    function toggleBillingForm() {
        if (differentBillingCheckbox.checked) {
            billingForm.style.display = 'block';
        } else {
            billingForm.style.display = 'none';
            copyShippingToBilling(); // Zkopíruje hodnoty, pokud fakturační adresa není použita
        }
    }

    // Při každé změně emailu v poli hostujícího uživatele
    if (guestEmailField) {
        guestEmailField.addEventListener('input', copyEmailToHiddenFields);
    }

    // Při aktivaci nebo deaktivaci fakturační adresy
    differentBillingCheckbox.addEventListener('change', () => {
        toggleBillingForm();
        if (differentBillingCheckbox.checked) {
            copyShippingToBilling(); // Zkopíruje hodnoty při zapnutí fakturační adresy
        }
    });

    // Kopírování hodnot mezi adresami při změně jednotlivých polí
    shippingFields.forEach((field, index) => {
        field.addEventListener('input', () => {
            if (!differentBillingCheckbox.checked && billingFields[index]) {
                billingFields[index].value = field.value;
            }
        });
    });

    // Inicializace
    copyEmailToHiddenFields();
    toggleBillingForm();
});

</script>

{% endblock %}
