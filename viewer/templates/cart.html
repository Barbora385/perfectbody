{% extends "base.html" %}

{% block content %}
    <h1 style="text-align: center;">Váš košík</h1>

    {% if cart %}
       <table style="width: 80%; margin: 20px auto; border-spacing: 0; text-align: left;">
    <thead>
    <tr>
        <th style="text-align: left;">Produkt</th>
        <th style="text-align: center;">Množství</th>
        <th style="text-align: center;">Cena za kus</th>
        <th style="text-align: center;">Celkem</th>
        <th style="text-align: center;">Poznámka</th>
        <th style="text-align: center;">Akce</th>
    </tr>
</thead>
<tbody>
{% for product_id, item in cart.items %}
    <tr>
        <td style="padding: 15px;">
            {% if item.product_type == 'service' %}
                <a href="{% url 'service' pk=product_id %}" style="color: blue; text-decoration: none;">
                    {{ item.product_name }}
                </a>
            {% else %}
                <a href="{% url 'product' pk=product_id %}" style="color: blue; text-decoration: none;">
                    {{ item.product_name }}
                </a>
            {% endif %}
        </td>
        <td style="text-align: center; padding: 15px;">
            <form data-product-id="{{ product_id }}">
                {% csrf_token %}
                <input type="number" name="quantity" value="{{ item.quantity }}" min="1"
                       style="width: 50px; text-align: center; border: 1px solid #ccc;">
            </form>
        </td>
        <td style="text-align: center;">{{ item.price }} Kč</td>
        <td style="text-align: center;" id="total-{{ product_id }}">{{ item.total }} Kč</td>
        <td style="padding: 15px;">
            <textarea name="note" class="note-input" data-product-id="{{ product_id }}"
                      style="width: 100%; border: 1px solid #ccc; resize: none;">{{ item.note }}</textarea>
        </td>
        <td style="text-align: center;">
            <a href="{% url 'remove_from_cart' product_id=product_id %}" style="text-decoration: none;">
                Odstranit
            </a>
        </td>
    </tr>
{% endfor %}
</tbody>
</table>



        <div style="margin: 20px auto; text-align: right; width: 80%;">
            <p><strong>Celková cena:</strong> <span id="cart-total">{{ total }} Kč</span></p>
            <a href="{% url 'start_order' %}">Pokračovat k objednávce</a>
        </div>
    {% else %}
        <p style="text-align: center; margin-top: 20px;">Váš košík je prázdný. <a href="{% url 'products' %}">Pokračovat
            v nákupu.</a></p>
    {% endif %}

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const initializeQuantityListeners = () => {
                document.querySelectorAll('input[name="quantity"]').forEach(input => {
                    input.addEventListener('change', function () {
                        const productId = this.closest('form').dataset.productId;
                        const quantity = this.value;

                        fetch(`/cart/update/${productId}/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}',
                                'X-Requested-With': 'XMLHttpRequest',
                            },
                            body: JSON.stringify({quantity})
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // Aktualizace celkové ceny položky a košíku
                                    document.querySelector(`#total-${productId}`).textContent = `${data.item_total} Kč`;
                                    document.querySelector('#cart-total').textContent = `${data.cart_total} Kč`;
                                } else {
                                    // Zobrazení chybové zprávy a reset hodnoty na původní množství
                                    alert(data.error || 'Aktualizace selhala!');
                                    this.value = this.defaultValue; // Reset na původní hodnotu
                                }
                            })
                            .catch(error => {
                                console.error('Chyba:', error);
                                alert('Nastala chyba při komunikaci se serverem.');
                                this.value = this.defaultValue; // Reset na původní hodnotu
                            });
                    });
                });
            };

            initializeQuantityListeners();
        });

    document.addEventListener('DOMContentLoaded', () => {
        // Odesílání poznámek
        document.querySelectorAll('.note-input').forEach(noteInput => {
            noteInput.addEventListener('change', function () {
                const productId = this.dataset.productId;
                const note = this.value;

                fetch(`/cart/update_note/${productId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: `note=${encodeURIComponent(note)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        alert(data.error || 'Nepodařilo se uložit poznámku.');
                    }
                })
                .catch(error => {
                    console.error('Chyba:', error);
                    alert('Nastala chyba při ukládání poznámky.');
                });
            });
        });
    });

    document.querySelectorAll('.update-cart').forEach(button => {
    button.addEventListener('click', () => {
        // Aktualizace na backendu přes AJAX
        fetch(button.dataset.url, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: JSON.stringify({ quantity: button.dataset.quantity }),
        })
            .then(response => response.json())
            .then(data => {
                // Aktualizace obsahu stránky `cart.html`
                document.getElementById('cart-items-container').innerHTML = data.html;

                // Vyvolání události pro aktualizaci dropdownu
                const event = new Event('cartUpdated');
                document.dispatchEvent(event);
            })
            .catch(error => console.error('Chyba při aktualizaci košíku:', error));
    });
});

</script>

{% endblock %}