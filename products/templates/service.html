{% extends "base.html" %}

{% load custom_filters %}

{% block content %}

    <!-- Breadcrumbs navigace -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb" style="display: flex; list-style: none; padding: 0;">
            <!-- Domů -->
            <li class="breadcrumb-item">
                <a href="{% url 'home' %}">Domů</a>
            </li>

            <!-- Oddělovač -->
            <li class="breadcrumb-item" style="margin: 0 5px;">&gt;</li>

            <!-- Hlavní kategorie služeb -->
            {% if service.category %}
                <li class="breadcrumb-item">
                    <a href="{% url 'services' %}">Kategorie služeb</a>
                </li>
            {% else %}
                <li class="breadcrumb-item active" aria-current="page">Kategorie služeb</li>
            {% endif %}

            <!-- Rodičovská kategorie, pokud existuje -->
            {% if service.category and service.category.category_parent %}
                <li class="breadcrumb-item" style="margin: 0 5px;">&gt;</li>
                <li class="breadcrumb-item">
                    <a href="{% url 'services' service.category.category_parent.pk %}">
                        {{ service.category.category_parent.category_name }}
                    </a>
                </li>
            {% endif %}

            <!-- Aktuální kategorie -->
            {% if service.category %}
                <li class="breadcrumb-item" style="margin: 0 5px;">&gt;</li>
                <li class="breadcrumb-item">
                    <a href="{% url 'services' service.category.pk %}">
                        {{ service.category.category_name }}
                    </a>
                </li>
            {% endif %}

            <!-- Název služby -->
            <li class="breadcrumb-item" style="margin: 0 5px;">&gt;</li>
            <li class="breadcrumb-item active" aria-current="page">
                {{ service.product_name }}
            </li>
        </ol>
    </nav>

    <h1>{{ service.product_name }}</h1>

    <!-- Obrázek služby -->
    {% if service.product_view %}
        <div class="service-image">
            <img src="{{ service.product_view }}" alt="Obrázek služby {{ service.product_name }}"
                 style="max-width: 450px; height: auto;">
        </div>
    {% endif %}

    <!-- Popis služby -->
    <div>
        <h2>Popis služby</h2>
        <p>{{ service.product_long_description }}</p>
    </div>

    <!-- Kategorie a cena -->
    <div>
        <p><strong>Kategorie:</strong> <a href="{% url 'services' service.category.pk %}">{{ service.category }}</a></p>

        <!-- Dostupní trenéři -->
        {% if approved_trainers_services %}
            <p>
                <strong>Trenéři:</strong>
                {% for trainer_service in approved_trainers_services %}
                    <a href="{% url 'trainer' trainer_service.trainer.id %}">{{ trainer_service.trainer.full_name }}</a>{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </p>
        {% else %}
            <p style="color: red;">Žádní schválení trenéři nejsou k dispozici pro tuto službu.</p>
        {% endif %}

        <p><strong>Cena:</strong> {{ service.price }} Kč</p>
    </div>
    <!-- Tlačítko pro přidání do košíku -->
    {% if approved_trainers_services %}
        <form method="post" action="{% url 'add_to_cart' service.id %}" class="add-to-cart">
            {% csrf_token %}
            <button type="submit"
                    style="padding: 0.5rem 1rem; font-size: 1rem; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                Přidat do košíku
        </button>
    </form>
{% else %}
    <p style="text-align: center; margin-top: 2rem; color: red;">
        Tuto službu nelze objednat. Žádný schválený trenér tuto službu nenabízí.
    </p>
{% endif %}
</div>
<!-- Možnosti pro administrátora: Upravit a Smazat službu -->
{% if user.is_staff %}
    <div style="margin-top: 2rem; text-align: center;">
        <a href="{% url 'edit_service' service.id %}" class="btn btn-sm btn-warning" style="margin-right: 1rem;">
            Upravit službu
        </a>
        <form method="post" action="{% url 'delete_service' service.id %}" class="delete-button">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Opravdu chcete smazat tuto službu?');">
                Smazat službu
            </button>
        </form>
    </div>
{% endif %}
<!-- Průměrné hodnocení -->
<div class="average-rating">
    <h2>Průměrné hodnocení</h2>
    {% if average_rating > 0 %}
        <p style="text-align: center;">
            <strong>{{ average_rating }} / 5</strong>
        </p>
        <div class="rating-stars" style="justify-content: center;">
            {% for state in star_states %}
                <span class="{{ state }}">★</span>
            {% endfor %}
        </div>
    {% else %}
        <p style="text-align: center;">Zatím žádné hodnocení</p>
    {% endif %}
</div>

<!-- Formulář pro přidání hodnocení -->
{% if user.is_authenticated %}
    <div class="add-review" style="margin-top: 2rem; text-align: center;">
        <h2>Hodnocení</h2>
        <form method="post" action="{% url 'add_service_review' service.id %}" style="display: inline-block; text-align: left;">
            {% csrf_token %}

            <!-- Hvězdičky pro hodnocení -->
            <label for="rating" style="display: block; text-align: center; margin-bottom: 0.5rem;">Hodnocení:</label>
            <div class="rating" style="justify-content: center;">
                {% for i in "54321" %}
                    <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}">
                    <label for="star{{ i }}" title="{{ i }} hvězdiček">★</label>
                {% endfor %}
            </div>

            <!-- Výběr trenéra -->
            <label for="trainer" style="display: block; text-align: center; margin-top: 1rem;">Trenér:</label>
            <select id="trainer" name="trainer" required style="width: 100%; margin-bottom: 1rem; padding: 0.5rem; font-size: 1rem;">
                {% for trainer_service in approved_trainers_services %}
                    <option value="{{ trainer_service.trainer.id }}">{{ trainer_service.trainer.full_name }}</option>
                {% empty %}
                    <option disabled>Žádný trenér není dostupný.</option>
                {% endfor %}
            </select>

            <!-- Komentář -->
            <label for="comment" style="display: block; text-align: center; margin-top: 1rem;">Komentář:</label>
            <textarea id="comment" name="comment" required placeholder="Napište svůj komentář..."
                      style="width: 100%; padding: 0.5rem; margin-bottom: 1rem; font-size: 1rem;"></textarea>

            <!-- Tlačítko -->
            <div style="text-align: center;">
                <button type="submit" style="padding: 0.5rem 1rem; font-size: 1rem; background-color: #3788ff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Přidat hodnocení
                </button>
            </div>
        </form>
    </div>
{% else %}
    <p style="text-align: center;">Pro přidání hodnocení se musíte přihlásit.</p>
{% endif %}


<!-- Zobrazení hodnocení -->
<div class="service-reviews" style="margin-top: 2rem; text-align: center;">
    <h2>Hodnocení</h2>
    {% if page_reviews %}
        {% for review in page_reviews %}
            <div class="review">
                <p><strong>Hodnotil:</strong> {{ review.reviewer.username }}</p>
                <p>
                    {% for i in "12345" %}
                        {% if forloop.counter <= review.rating %}
                            <span style="color: #f5b301;">★</span>
                        {% else %}
                            <span style="color: #ccc;">★</span>
                        {% endif %}
                    {% endfor %}
                </p>
                <p>{{ review.comment }}</p>

                <!-- Tlačítko pro mazání hodnocení pro administrátory -->
                {% if user.is_staff %}
                    <form method="post" action="{% url 'delete_service_review' review.id %}" class="delete-button">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Opravdu chcete smazat toto hodnocení?');">
                            Smazat hodnocení
                        </button>
                    </form>
                {% endif %}
            </div>
        {% endfor %}

        <!-- Navigace stránkování -->
        <div class="pagination" style="margin-top: 1.5rem;">
            <span class="step-links">
                {% if page_reviews.has_previous %}
                    <a href="?page=1">&laquo; První</a>
                    <a href="?page={{ page_reviews.previous_page_number }}">Předchozí</a>
                {% endif %}

                <span>Stránka {{ page_reviews.number }} z {{ page_reviews.paginator.num_pages }}</span>

                {% if page_reviews.has_next %}
                    <a href="?page={{ page_reviews.next_page_number }}">Další</a>
                    <a href="?page={{ page_reviews.paginator.num_pages }}">Poslední &raquo;</a>
                {% endif %}
            </span>
        </div>
    {% else %}
        <p>Zatím zde nejsou žádná hodnocení.</p>
    {% endif %}
</div>

{% endblock %}